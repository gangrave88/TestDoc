# КомплексноеЗакрытиеКонтейнера

## 0. Call Tree

1. Основний метод `КомплексноеЗакрытиеКонтейнера`
    1.1. [[НеобходимоПолучатьЕН]] - перевірка необхідності отримання електронної накладної
    1.2. [[ЗакрытиеКонтейнера]] - встановлення статусу "Закрыт", додавання пломб, розрахунок ціни та ваги
    1.3. [[СкретчКартыВКонтейнере]] - перевірка наявності скретч-карт у контейнері
    1.4. `JSON._ПрочитатьJSON` - парсинг JSON-рядка
    1.5. [[ПолучитьЕНКонтейнера]] - отримання електронної накладної від кур'єрської служби
    1.6. [[КурьерскиеСлужбы.СоздатьBatch]] - створення пакету у системі кур'єрської служби
    1.7. [[КурьерскиеСлужбы.ПолучитьЭтикетку]] - отримання та друк етикетки контейнера
    1.8. [[ПечатьФорма1ТН]] - друк транспортної накладної форми 1 (для ЛВІ товарів)
    1.9. [[ПечатьОбычнаяФорма]] - друк накладної звичайної форми
    1.10. [[КурьерскиеСлужбы.ПолучитьРеестрCouriers2]] - формування реєстру для Мост Міжнародна
    1.11. [[ОтменитьЗакрытиеКонтейнера]] - відкат закриття контейнера у разі помилки

## 1. High-Level Goal

Виконати комплексне закриття контейнера, що включає: валідацію параметрів друку, встановлення статусу "Закрыт" з пломбами, отримання електронної накладної від кур'єрської служби, створення batch, друк етикетки та супровідних документів. Функція підтримує як веб-сервісний режим, так і режим роботи з клієнтської частини.

## 2. Data Transformations

### Input (Вхід)

**Структура СтруктураПараметров**:
- `Контейнер` *(Обов'язково)*: Посилання на документ Контейнер
- `ДляВебСервиса` *(Опціонально)*: Прапорець, що визначає режим роботи (веб-сервіс/клієнт)
- `StringJson` *(Опціонально)*: JSON-рядок з даними:
  - `NumberOfSeats` *(Число)*: Кількість місць для створення ЕН
  - `Stamp` *(Масив рядків)*: Масив номерів пломб
- `ПринтерЭтикеток` *(Обов'язково для клієнта)*: Назва принтера для друку етикеток
- `ПринтерДокументов` *(Обов'язково для клієнта)*: Назва принтера для друку документів

### Transformation (Трансформація)

1. **Валідація принтерів** (тільки для клієнтського режиму):
   - Якщо необхідно отримувати ЕН і не вказано `ПринтерЭтикеток` → помилка
   - Якщо не вказано `ПринтерДокументов` → помилка

2. **Закриття контейнера**:
   - Викликається `ЗакрытиеКонтейнера` для встановлення статусу "Закрыт"
   - Додаються пломби (з JSON або через діалог на клієнті)
   - Розраховуються вага та залогова вартість для товарних позицій

3. **Обробка електронної накладної**:
   - Якщо потрібна ЕН (`НеобходимоПолучатьЕН` = Істина):
     - Для контейнера типу 4 з веб-сервісу: витягується `NumberOfSeats` з JSON
     - Для інших: опціонально читається `NumberOfSeats` з JSON або = 0
     - Викликається `ПолучитьЕНКонтейнера`
     - Отриманий `НомерЕН` записується в поле `ВнешнийИДКонтейнера` (крім типу 5 з заповненим ІД)
   - Якщо ЕН не потрібна: `НомерЕН` = `Контейнер.Номер`

4. **Обробка скретч-карт**:
   - Якщо в контейнері є скретч-карти (`СкретчКартыВКонтейнере` = Істина):
     - Повторно викликається `ПолучитьЕНКонтейнера` з параметром реєстрації в Octopus
     - Batch НЕ створюється
   - Якщо скретч-карт немає:
     - Створюється Batch через `КурьерскиеСлужбы.СоздатьBatch`

5. **Друк етикетки** (тільки якщо потрібна ЕН і НЕ веб-сервісний режим):
   - Отримується етикетка через `КурьерскиеСлужбы.ПолучитьЭтикетку`
   - Встановлюється `АвтоМасштаб = Истина`
   - Виконується друк на `ПринтерЭтикеток`

6. **Друк документів** (тільки якщо `КурьерскаяСлужба` ≠ "Доставка" і НЕ веб-сервіс):
   - Перевірка наявності товарів з групи ЛВІ (запит до `Справочник.Номенклатура`)
   - Якщо є ЛВІ → `ПечатьФорма1ТН` (форма 1 транспортної накладної)
   - Якщо немає ЛВІ і немає допПараметра "КоличествоМест" → `ПечатьОбычнаяФорма`

7. **Формування реєстру для Мост Міжнародна**:
   - Запит товарів з `WMSУпаковкаОтгрузка`, де `Направление.Курьер8 = ИСТИНА`
   - Для кожного серійного номера формується структура з `WaybillUID`, `DocType`, `DocUID`, `Places`
   - Викликається `КурьерскиеСлужбы.ПолучитьРеестрCouriers2`
   - При помилці → виклик `ОтменитьЗакрытиеКонтейнера` (відкат)

### Output (Вихід)

**Структура Ответ**:
- `Ошибка` *(Рядок, опціонально)*: Текст помилки (якщо виникла)
- `НомерЕН` *(Рядок)*: Номер електронної накладної (або номер контейнера)
- `Этикетка` *(ТабличныйДокумент, опціонально)*: Табличний документ етикетки (тільки для клієнта)

## 3. Process Flow

1. Ініціалізація змінних:
   - Створити структуру `Ответ`
   - Отримати `Контейнер` з `СтруктураПараметров.Контейнер`

2. **Валідація параметрів друку** (тільки для клієнтського режиму):
   1. ЯКЩО `НЕ СтруктураПараметров.Свойство("ДляВебСервиса")`, ТО:
      1. ЯКЩО `НЕ СтруктураПараметров.Свойство("ПринтерЭтикеток")` І для контейнера необхідно отримувати ЕН (перевірка через [[НеобходимоПолучатьЕН]]), ТО:
         - Встановити `Ответ.Ошибка = "Не выбран принтер для печати этикеток"`
         - Повернути `Ответ`
      2. ЯКЩО `НЕ СтруктураПараметров.Свойство("ПринтерДокументов")`, ТО:
         - Встановити `Ответ.Ошибка = "Не выбран принтер для печати документов"`
         - Повернути `Ответ`

3. **Закриття контейнера**:
   1. Викликати [[ЗакрытиеКонтейнера]](СтруктураПараметров)
      - *Результат*: Структура з можливим полем `Ошибка`
   2. ЯКЩО у відповіді є поле `Ошибка`, ТО:
      - Скопіювати помилку в `Ответ.Ошибка`
      - Повернути `Ответ`

4. **Перевірка наявності скретч-карт**:
   1. Викликати [[СкретчКартыВКонтейнере]](Контейнер)
      - *Результат*: Булеве значення, що записується в змінну `ЕстьСкретчКартыВКонтейнере`

5. **Отримання електронної накладної**:
   1. ЯКЩО для контейнера необхідно отримувати ЕН (перевірка через [[НеобходимоПолучатьЕН]]), ТО:
      
      1. **Обробка для типу контейнера 4 з веб-сервісу**:
         ЯКЩО `Контейнер.ТипКонтейнера = 4` І є властивість `ДляВебСервиса` і `StringJson`, ТО:
         1. Спробувати розпарсити JSON через `JSON._ПрочитатьJSON(СтруктураПараметров.StringJson)`
         2. При помилці → встановити `Ответ.Ошибка = "Не удалось прочитать строку JSON"`, повернути
         3. Витягти значення поля `NumberOfSeats` з результату парсингу
         4. ЯКЩО `NumberOfSeats` є числом і заповнено, ТО:
            - Викликати [[ПолучитьЕНКонтейнера]](Контейнер, КоличествоМест)
         5. ІНАКШЕ:
            - Встановити помилку "Не получено количество мест...", повернути
      
      2. **Обробка для інших типів**:
         ІНАКШЕ:
         1. Встановити `КоличествоМест = 0`
         2. ЯКЩО є властивість `StringJson`, ТО:
            - Спробувати розпарсити JSON
            - При успіху витягти `NumberOfSeats` (ігноруючи помилки)
         3. Викликати [[ПолучитьЕНКонтейнера]](Контейнер, КоличествоМест)
      
      3. ЯКЩО у відповіді `ПолучитьЕНКонтейнера` є поле `Ошибка`, ТО:
         - Скопіювати помилку в `Ответ.Ошибка`
         - Повернути `Ответ`
      4. ІНАКШЕ:
         - Встановити `Ответ.НомерЕН = Результат.НомерЕН`
   
   2. ІНАКШЕ (ЕН не потрібна):
      - Встановити `Ответ.НомерЕН = Контейнер.Номер`

6. **Запис зовнішнього ІД контейнера**:
   1. ЯКЩО `Контейнер.ТипКонтейнера <> 5` АБО поле `ВнешнийИДКонтейнера` не заповнено, ТО:
      1. Отримати об'єкт контейнера: `оКонтейнер = Контейнер.ПолучитьОбъект()`
      2. Встановити `оКонтейнер.ВнешнийИДКонтейнера = Ответ.НомерЕН`
      3. Записати: `оКонтейнер.Записать(РежимЗаписиДокумента.Запись)`

7. **Додаткова реєстрація скретч-карт в Octopus**:
   1. ЯКЩО `ЕстьСкретчКартыВКонтейнере = Истина`, ТО:
      1. Створити структуру `НеобязательныеПараметры` з полем `РегистрацияСкретчКартВOctopus = 1`
      2. Викликати [[ПолучитьЕНКонтейнера]](Контейнер, КоличествоМест, НеобязательныеПараметры)
      3. ЯКЩО у відповіді є `Ошибка`, ТО:
         - Скопіювати помилку в `Ответ.Ошибка`
         - Повернути `Ответ`

8. **Створення Batch** (тільки якщо немає скретч-карт):
   1. ЯКЩО `ЕстьСкретчКартыВКонтейнере = Ложь`, ТО:
      1. Створити `ПараметрыСозданияBatch`:
         - `Документы` = масив з одним елементом `Контейнер`
      2. Викликати [[КурьерскиеСлужбы.СоздатьBatch]](ПараметрыСозданияBatch)
         - *Результат*: Структура з полем `Успешно` та опціональним `Ошибка`
      3. ЯКЩО `НЕ РезультатBatch.Успешно`, ТО:
         1. Сформувати текст помилки:
            - ЯКЩО є властивість `Ошибка` → використати її
            - ІНАКШЕ: витягти з `РезультатBatch.Данные[0].Ошибка` або "Неизвестная ошибка..."
         2. Встановити `Ответ.Ошибка = ТекстОшибки`
         3. Повернути `Ответ`

9. **Друк етикетки** (тільки для клієнта з необхідністю ЕН):
   1. ЯКЩО необхідно отримувати ЕН (перевірка через [[НеобходимоПолучатьЕН]]) І `НЕ ДляВебСервиса`, ТО:
      1. Викликати [[КурьерскиеСлужбы.ПолучитьЭтикетку]](Контейнер)
         - *Результат*: Структура з полем `ТабличныйДокумент` або `Ошибка`
      2. ЯКЩО у відповіді є `Ошибка`, ТО:
         - Скопіювати помилку в `Ответ.Ошибка`
         - Повернути `Ответ`
      3. ІНАКШЕ:
         1. ЯКЩО `Результат.ТабличныйДокумент.ВысотаТаблицы <> 0`, ТО:
            - Встановити `АвтоМасштаб = Истина`
            - Встановити `ИмяПринтера = СтруктураПараметров.ПринтерЭтикеток`
            - Викликати `Напечатать()`
         2. Встановити `Ответ.Этикетка = Результат.ТабличныйДокумент`

10. **Друк документів** (тільки для клієнта, якщо не "Доставка"):
    1. ЯКЩО `Контейнер.КурьерскаяСлужба <> "Доставка"` І `НЕ ДляВебСервиса`, ТО:
       
       1. **Перевірка наявності ЛВІ товарів**:
          1. Виконати SQL-запит:
             ```sql
             ВЫБРАТЬ Номенклатура.Ссылка
             ИЗ Справочник.Номенклатура КАК Номенклатура
             ГДЕ Номенклатура.Ссылка В(&МассивТоваров)
                 И Номенклатура.Ссылка В ИЕРАРХИИ(&ГруппаЛВИ)
             ```
             - Параметри:
               - `ГруппаЛВИ` = `глПеременные.грЛВИ()`
               - `МассивТоваров` = `Контейнер.ТЧТовары.ВыгрузитьКолонку("Товар")`
       
       2. **Друк відповідної форми**:
          1. ЯКЩО результат запиту НЕ порожній (є ЛВІ товари), ТО:
             - Викликати [[ПечатьФорма1ТН]](Контейнер, СтруктураПараметров.ПринтерДокументов, , 3)
          2. ІНАКШЕ:
             1. Знайти допПараметр "КоличествоМест" в `Контейнер.ДопПараметры`
             2. ЯКЩО параметр НЕ знайдено, ТО:
                - Викликати [[ПечатьОбычнаяФорма]](Контейнер, СтруктураПараметров.ПринтерДокументов)
       
       3. ЯКЩО у відповіді друку є `Ошибка`, ТО:
          - Скопіювати помилку в `Ответ.Ошибка`
          - Повернути `Ответ`

11. **Формування реєстру для Мост Міжнародна**:
    1. Створити та виконати SQL-запит:
       ```sql
       ВЫБРАТЬ
           WMSУпаковкаОтгрузка.ШтрихКод,
           WMSУпаковкаОтгрузка.КвоМест,
           WMSУпаковкаОтгрузка.Документ
       ИЗ Документ.Контейнер.ТЧТовары КАК КонтейнерТЧТовары
           ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.WMSУпаковкаОтгрузка КАК WMSУпаковкаОтгрузка
           ПО КонтейнерТЧТовары.СерийныйНомер = WMSУпаковкаОтгрузка.ШтрихКод
       ГДЕ КонтейнерТЧТовары.Ссылка = &Ссылка
           И WMSУпаковкаОтгрузка.Направление.Курьер8 = ИСТИНА
       ```
       - Параметр `Ссылка = Контейнер.Ссылка`
    
    2. Створити масив `ДанныеСчетовМостМеждународная`
    
    3. Для кожного рядка результату запиту:
       1. Створити структуру `ДанныеСчета`:
          - `WaybillUID` = `Элемент.ШтрихКод`
          - `DocType` = "Счет"
          - `DocUID` = Строка УникальногоІдентифікатора документа
          - `Places` = `Элемент.КвоМест`
       2. Додати структуру в масив
    
    4. ЯКЩО масив НЕ порожній, ТО:
       1. Створити `ДанныеДляРеестра`:
          - `ДанныеСчетов` = `ДанныеСчетовМостМеждународная`
          - `Принтер` = "M8_Default"
       2. Викликати [[КурьерскиеСлужбы.ПолучитьРеестрCouriers2]](ДанныеДляРеестра)
          - *Результат*: Структура з можливим полем `Ошибка`
       3. ЯКЩО у відповіді є `Ошибка`, ТО:
          - Скопіювати помилку в `Ответ.Ошибка`
          - Викликати [[ОтменитьЗакрытиеКонтейнера]](Контейнер) для відкату змін
          - Повернути `Ответ`

12. Повернути `Ответ`

## 4. Critical Snippet

### Розрахунок кількості місць з JSON (різна логіка для типу 4)

```bsl
Если Контейнер.ТипКонтейнера = 4 И СтруктураПараметров.Свойство("ДляВебСервиса") И СтруктураПараметров.Свойство("StringJson") Тогда
    // Для типу 4 з веб-сервісу - NumberOfSeats ОБОВ'ЯЗКОВИЙ
    РезультатЧтения = JSON._ПрочитатьJSON(СтруктураПараметров.StringJson);
    РезультатЧтения.Свойство("NumberOfSeats", КоличествоМест);
    Если ТипЗнч(КоличествоМест) = Тип("Число") И ЗначениеЗаполнено(КоличествоМест) Тогда
        Результат = ПолучитьЕНКонтейнера(Контейнер, КоличествоМест);
    Иначе
        Ответ.Вставить("Ошибка", "Не получено количество мест...");
        Возврат Ответ;
    КонецЕсли;
Иначе
    // Для інших типів - NumberOfSeats опціональний (за замовчуванням 0)
    КоличествоМест = 0;
    Если СтруктураПараметров.Свойство("StringJson") Тогда
        Попытка
            РезультатЧтения = JSON._ПрочитатьJSON(СтруктураПараметров.StringJson);
            РезультатЧтения.Свойство("NumberOfSeats", КоличествоМест);
        Исключение
        КонецПопытки;
    КонецЕсли;
    Результат = ПолучитьЕНКонтейнера(Контейнер, КоличествоМест);
КонецЕсли;
```

### Формування даних для реєстру Мост Міжнародна

```bsl
Запрос.Текст = "ВЫБРАТЬ
    |    WMSУпаковкаОтгрузка.ШтрихКод,
    |    WMSУпаковкаОтгрузка.КвоМест,
    |    WMSУпаковкаОтгрузка.Документ
    |ИЗ
    |    Документ.Контейнер.ТЧТовары КАК КонтейнерТЧТовары
    |        ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.WMSУпаковкаОтгрузка КАК WMSУпаковкаОтгрузка
    |        ПО КонтейнерТЧТовары.СерийныйНомер = WMSУпаковкаОтгрузка.ШтрихКод
    |ГДЕ
    |    КонтейнерТЧТовары.Ссылка = &Ссылка
    |    И WMSУпаковкаОтгрузка.Направление.Курьер8 = ИСТИНА";

ДанныеСчетовМостМеждународная = Новый Массив();
Для Каждого Элемент Из Запрос.Выполнить().Выгрузить() Цикл
    ДанныеСчета = Новый Структура();
    ДанныеСчета.Вставить("WaybillUID", Элемент.ШтрихКод);
    ДанныеСчета.Вставить("DocType", "Счет");
    ДанныеСчета.Вставить("DocUID", Строка(Элемент.Документ.УникальныйИдентификатор()));
    ДанныеСчета.Вставить("Places", Элемент.КвоМест);
    ДанныеСчетовМостМеждународная.Добавить(ДанныеСчета);
КонецЦикла;
```

## 5. Edge Cases & Error Handling

### Бізнес-логіка помилок

1. **Відсутність принтерів** (режим клієнта):
   - Перевірка наявності `ПринтерЭтикеток` виконується ТІЛЬКИ якщо необхідно отримувати ЕН
   - Перевірка наявності `ПринтерДокументов` виконується завжди
   - Помилка повертається негайно без виконання подальших кроків

2. **Помилки отримання ЕН**:
   - При помилці парсингу JSON повертається "Не удалось прочитать строку JSON"
   - Для типу контейнера 4: відсутність або невалідне значення `NumberOfSeats` є критичною помилкою
   - Для інших типів: відсутність `NumberOfSeats` не є помилкою (використовується 0)

3. **Помилки створення Batch**:
   - Текст помилки витягується з різних джерел:
     - Безпосередньо з `РезультатBatch.Ошибка`
     - З першого елемента масиву `РезультатBatch.Данные[0].Ошибка`
     - Якщо нічого не знайдено: "Неизвестная ошибка при создании Batch"

4. **Критична помилка реєстру Мост Міжнародна**:
   - При помилці формування реєстру викликається **відкат** через `ОтменитьЗакрытиеКонтейнера`
   - Це ЄДИНИЙ випадок у функції, коли виконується автоматичний відкат змін

5. **Скретч-карти**:
   - Якщо є скретч-карти, то Batch НЕ створюється
   - Замість цього виконується додатковий виклик `ПолучитьЕНКонтейнера` з параметром реєстрації в Octopus

6. **Умовна друк документів**:
   - Друк "Состав контейнера" (`ПечатьОбычнаяФорма`) НЕ виконується, якщо контейнер має допПараметр "КоличествоМест"
   - Це означає, що документ створено з обробки "Перемещение клиентского товара после сервисного обслуживания на магазины"

7. **Запис зовнішнього ІД**:
   - Для контейнерів типу 5 (тип "Збірний"?) з вже заповненим `ВнешнийИДКонтейнера` перезапис НЕ виконується
   - Для всіх інших випадків поле оновлюється значенням `НомерЕН`

### Режими роботи

**Веб-сервісний режим** (`ДляВебСервиса = Истина`):
- Валідація принтерів НЕ виконується
- Друк етикеток та документів НЕ виконується
- Пломби приймаються виключно з JSON (`Stamp`)
- Кількість місць приймається з JSON (`NumberOfSeats`)

**Клієнтський режим** (`ДляВебСервиса` відсутнє):
- Обов'язкова валідація принтерів
- Виконується друк етикеток та документів
- Пломби можуть вводитися через діалог (якщо немає JSON або помилка парсингу)
- Кількість місць може прийматися з JSON або бути 0
