# ChangeContainerStatusОбработать

## 0. Call Tree (Дерево викликів)

1. Основний метод `ChangeContainerStatusОбработать`
    1.1. Створення об'єкта відповіді XDTO
    1.2. Валідація вхідних параметрів
    1.3. Пошук контейнера в базі даних (за ідентифікатором або номером)
    1.4. [[ГлобальныйМодуль.ПолучитьРазрешенныеОбъекты]] (створити файл `docs/ПолучитьРазрешенныеОбъекты.md`)
    1.5. Перевірка прав доступу до складу-відправника
    1.6. [[Документы.Контейнер.УправлениеКонтейнером]] (створити файл `docs/УправлениеКонтейнером.md`)

## 1. High-Level Goal (Високорівнева мета)

Функція виконує зміну статусу контейнера на основі запиту від WMS: валідує вхідні дані, знаходить контейнер у базі, перевіряє права доступу користувача до складу-відправника та делегує виконання дії до модуля управління контейнерами.

## 2. Data Transformations (Трансформація даних)

### Input (Вхід)
- **Request** (тип XDTO): Об'єкт запиту веб-сервісу
  - `Container`: Ідентифікатор контейнера (формат: `$$E<WMS_ID>` або `$$K<Номер>`)
  - `ActionID`: Ідентифікатор дії (число)
  - `Attachments`: Додаткові дані у форматі JSON (опціонально)

### Transformation (Трансформація)
1. Валідація наявності параметра `Container`
2. Парсинг ідентифікатора контейнера (визначення типу: WMS ID або номер)
3. Пошук контейнера в базі даних `Документ.Контейнер` з отриманням `Ссылка` та `Отправитель`
4. Перевірка прав доступу поточного користувача до складу-відправника
5. Формування структури параметрів для управління контейнером
6. Виконання дії над контейнером

### Output (Вихід)
- **Ответ** (тип XDTO: `ChangeContainerStatus_Info`): Об'єкт відповіді
  - `Succes`: Булеве значення успішності операції
  - `Error`: Текст помилки (якщо є)

## 3. Process Flow (Покроковий процес)

### Блок 1: Ініціалізація та створення об'єкта відповіді

1. Створення типу відповіді через `ФабрикаXDTO.Тип` з параметрами:
   - URI: `"http://pup.local/wsWMS/XDTO"`
   - Тип: `"ChangeContainerStatus_Info"`

2. Створення об'єкта відповіді `Ответ` на основі створеного типу

### Блок 2: Валідація параметра Container

3. Отримання значення `Container` з `Request.Container`

4. **ЯКЩО** параметр `Container` НЕ заповнено, **ТО**:
   - Встановити `Ответ.Succes = Ложь`
   - Встановити `Ответ.Error = "Не заполнен параметр ""Container""."`
   - Повернути `Ответ` (завершення функції)

### Блок 3: Визначення типу ідентифікатора та пошук контейнера

5. Отримання перших 3 символів з `Container` в змінну `НачСимволы`

6. **Визначення формату ідентифікатора та формування умови запиту:**

   **ЯКЩО** `НачСимволы = "$$E"` (ідентифікатор WMS), **ТО**:
   - Пошук контейнера за умовою: `Контейнер.ИдентификаторWMS = Container`

   **ІНАКШЕ ЯКЩО** `НачСимволы = "$$K"` (номер контейнера), **ТО**:
   - Пошук контейнера за умовою: `Контейнер.Номер = Container` (без префіксу `$$K`, тобто з 4-го символу)

   **ІНАКШЕ** (невідомий формат), **ТО**:
   - Встановити `Ответ.Error = "Неверный формат данных в параметре ""Container""."`
   - Повернути `Ответ` (завершення функції)

7. **Виконання запиту до бази даних** `Документ.Контейнер` за визначеною умовою
   
   **Отримані дані:**
   - `Ссылка` - посилання на знайдений документ контейнера
   - `Отправитель` - склад-відправник контейнера

8. **ЯКЩО** контейнер не знайдено (результат порожній), **ТО**:
   - Встановити `Ответ.Succes = Ложь`
   - Встановити `Ответ.Error = "Контейнер не найден."` (⚠️ **КРИТИЧНО**: Текст помилки не змінювати, hardcoded в WMS)
   - Повернути `Ответ` (завершення функції)

9. Збереження знайденого контейнера: `Контейнер = Выборка.Ссылка`

10. Збереження складу-відправника: `СкладОтправитель = Выборка.Отправитель`

### Блок 4: Перевірка прав доступу

11. Ініціалізація прапорця: `ОграниченныеПрава = Ложь`

12. Виклик [[ГлобальныйМодуль.ПолучитьРазрешенныеОбъекты]]:
    - **Параметри**: 
      - Тип об'єктів: `"МестаХранения"`
      - `ОграниченныеПрава` (*Output*: встановлюється в `Истина` якщо у користувача обмежені права)
    - **Результат**: Записується в змінну `РазрешенныеСклады` - список дозволених складів для поточного користувача

13. **ЯКЩО** у користувача обмежені права (`ОграниченныеПрава = Истина`), **ТО**:

14. Пошук складу-відправника у списку дозволених: `НайденноеЗначение = РазрешенныеСклады.НайтиПоЗначению(СкладОтправитель)`

15. **ЯКЩО** склад НЕ знайдено в дозволених (`НайденноеЗначение = Неопределено`), **ТО**:
    - Встановити `Ответ.Succes = Ложь`
    - Встановити `Ответ.Error` з повідомленням про відсутність прав доступу (включає ім'я користувача та назву складу)
    - Повернути `Ответ` (завершення функції)

### Блок 5: Підготовка параметрів та виконання дії

16. Створення структури параметрів: `СтруктураПараметров = Новый Структура`

17. Додавання обов'язкових параметрів:
    - `ДляВебСервиса` (без значення - прапорець)
    - `Контейнер` = знайдена ссылка на контейнер
    - `Действие` = `Request.ActionID`

18. **ЯКЩО** параметр `Request.Attachments` заповнено, **ТО**:
    - Додати до структури параметр `StringJson = Request.Attachments`

19. Виклик [[Документы.Контейнер.УправлениеКонтейнером]]:
    - **Параметри**: `СтруктураПараметров` - структура з підготовленими параметрами
    - **Результат**: Записується в змінну `Результат` - структура з результатом виконання дії

20. **ЯКЩО** результат містить властивість `"Ошибка"`, **ТО**:
    - Встановити `Ответ.Succes = Ложь`
    - Встановити `Ответ.Error = Результат.Ошибка`

21. **ІНАКШЕ** (успішне виконання), **ТО**:
    - Встановити `Ответ.Succes = Истина`

22. Повернути `Ответ`

## 4. Critical Snippet (Критичний фрагмент)

### Парсинг ідентифікатора контейнера

```bsl
НачСимволы = Лев(Container,3);
Если НачСимволы = "$$E" Тогда 	
    Запрос.Текст = 
    "ВЫБРАТЬ
    |	Контейнер.Ссылка,
    |	Контейнер.Отправитель
    |ИЗ
    |	Документ.Контейнер КАК Контейнер
    |ГДЕ
    |	Контейнер.ИдентификаторWMS = &WMSID";
    Запрос.УстановитьПараметр("WMSID", Container);
ИначеЕсли НачСимволы = "$$K" Тогда
    Запрос.Текст = 
    "ВЫБРАТЬ
    |	Контейнер.Ссылка,
    |	Контейнер.Отправитель
    |ИЗ
    |	Документ.Контейнер КАК Контейнер
    |ГДЕ
    |	Контейнер.Номер = &Номер";
    Запрос.УстановитьПараметр("Номер", Сред(Container,4));
Иначе
    Ответ.Error = "Неверный формат данных в параметре ""Container"".";
    Возврат Ответ;
КонецЕсли;
```

### Перевірка прав доступу

```bsl
ОграниченныеПрава = Ложь;
РазрешенныеСклады = ГлобальныйМодуль.ПолучитьРазрешенныеОбъекты("МестаХранения", ОграниченныеПрава);
Если ОграниченныеПрава Тогда
    НайденноеЗначение = РазрешенныеСклады.НайтиПоЗначению(СкладОтправитель);
    Если НайденноеЗначение = Неопределено Тогда
        Ответ.Succes = Ложь;
        Ответ.Error = "У пользователя """+ПараметрыСеанса.ТекущийПользователь+""" нет прав доступа на склад-отправитель """+СкладОтправитель+""".";
        Возврат Ответ;
    КонецЕсли;
КонецЕсли;
```

## 5. Edge Cases & Error Handling (Граничні випадки та обробка помилок)

### Валідація вхідних даних

1. **Порожній параметр Container**
   - Повертається помилка: `"Не заполнен параметр ""Container""."`
   - `Succes = Ложь`

2. **Невірний формат Container**
   - Очікується префікс `$$E` (WMS ID) або `$$K` (номер)
   - Якщо інший формат → помилка: `"Неверный формат данных в параметре ""Container""."`

3. **Контейнер не знайдено**
   - Повертається помилка: `"Контейнер не найден."`
   - ⚠️ **ВАЖЛИВО**: Текст помилки захардкоджено в WMS, не можна змінювати

### Безпека та права доступу

4. **Обмеження прав доступу**
   - Метод `ПолучитьРазрешенныеОбъекты` визначає чи має користувач обмеження
   - Якщо обмеження є - перевіряється наявність складу-відправника в списку дозволених
   - При відсутності доступу → повертається персоналізована помилка з іменем користувача та складу

5. **Вихідний параметр `ОграниченныеПрава`**
   - Спочатку ініціалізується як `Ложь`
   - Передається як output-параметр у `ПолучитьРазрешенныеОбъекты`
   - Після виклику містить `Истина` якщо у користувача обмежені права

### Обробка результату виконання дії

6. **Перевірка наявності помилки**
   - Результат від `УправлениеКонтейнером` перевіряється на наявність властивості `"Ошибка"`
   - Якщо властивість присутня → операція вважається невдалою
   - Інакше → операція успішна (`Succes = Истина`)

### Опціональні параметри

7. **Attachments**
   - Параметр опціональний
   - Додається до структури тільки якщо заповнений
   - Передається як `StringJson` в управління контейнером
